/*! Knockout App - v0.2.0 - 2012-12-28
* https://github.com/paglias/KnockoutApp
* Copyright (c) 2012 Matteo Pagliazzi; Licensed MIT */

(function(){var t=this,e=t.ko;if(e===void 0)throw"KnockoutJS must be loaded to use KnockoutApp";var i=t.KnockoutApp={};i.VERSION="0.2.0";var r=i.Utils={isObservableArray:function(t){return e.isObservable(t)&&void 0!==t.destroyAll},extendObjKnockout:function(t,i){for(var n in i){var s=i[n];"object"==typeof s&&null!==s&&t[n]&&!e.isWriteableObservable(t[n])?r.extendObjKnockout(t[n],s):r.isObservableArray(t[n])?s instanceof Array?t[n](s):t[n].push(s):e.isWriteableObservable(t[n])?t[n](s):t[n]=s}return t},cloneObjKnockout:function(t){if(e.isWriteableObservable(t))return e.observable(t());if(null===t||"object"!=typeof t)return t;var i=t.constructor();for(var n in t)i[n]=r.cloneObjKnockout(t[n]);return i},extendClass:function(t,i){var r,n=this,s=function(){};return r=t&&t.hasOwnProperty("constructor")?t.constructor:function(){n.apply(this,arguments)},e.utils.extend(r,n),s.prototype=n.prototype,r.prototype=new s,t&&e.utils.extend(r.prototype,t),i&&e.utils.extend(r,i),r.prototype.constructor=r,r.__super__=n.prototype,r.extend=n.extend,r},unwrapValue:function(t,e){if(null===t)return null;var i=t[e];return"function"==typeof i?i.call(t):i},wrapError:function(){var t=Array.prototype.slice.call(arguments);console.log("Error ",t)}},n=i.Model=function(t,i){if(this.id=e.observable(!1),this.attributes={},t){t[this.idAttribute]&&(this.id(t[this.idAttribute]),delete t[this.idAttribute]);var n=r.cloneObjKnockout(this.defaultAttributes);this.attributes=r.extendObjKnockout(n,t)}i&&i.collection&&(this.collection=i.collection),this.isNew=e.computed(function(){return this.id()===!1?!0:!1},this),this.initialize&&this.initialize.apply(this,arguments)};e.utils.extend(n.prototype,{defaultAttributes:{},idAttribute:"id",sync:function(){return(this.collection&&this.collection.sync||i.Sync).apply(this,arguments)},url:function(){var t=r.unwrapValue(this,"baseUrl")||this.collection&&r.unwrapValue(this.collection,"url");return this.isNew()?t:t+("/"===t[t.length-1]?"":"/")+this.id()},validate:function(){return!0},fetch:function(t){var i=this,n={};return n.success=function(t){delete t[i.idAttribute];var e=r.cloneObjKnockout(i.defaultAttributes);i.attributes=r.extendObjKnockout(e,t)},t&&e.utils.extend(n,t),this.sync.call(this,"fetch",this,n)},save:function(t){if(this.validate()!==!0)return!1;var i=this,r={},n=this.isNew()?"create":"update";return r.success=function(t){"create"===n&&i.id(t[i.idAttribute])},t&&e.utils.extend(r,t),this.sync.call(this,n,this,r)},destroy:function(t){var i=this,r={};if(r.success=function(){i.collection&&(i.collection.models.remove(i),delete i.collection)},t&&e.utils.extend(r,t),this.isNew())return r.success(),!1;var n=this.sync.call(this,"destroy",this,r);return r.wait||(r.success(),delete r.success),n},toJSON:function(){var t=e.toJS(this.attributes);return this.id()&&(t[this.idAttribute]=this.id()),t}});var s=i.Collection=function(t){this.model=t||i.Model,this.models=e.observableArray(),this.initialize&&this.initialize.apply(this,arguments)};e.utils.extend(s.prototype,{sync:function(){return i.Sync.apply(this,arguments)},fetch:function(t){var i=this,r={};return r.success=function(t){var e=[];for(var r in t)e.push(t[r]);e.length>0&&i.add(e)},r&&e.utils.extend(r,t),this.sync.call(this,"fetch",this,r)},add:function(t,i){var r=t instanceof Array?t:[t],s=this;e.utils.arrayForEach(r,function(t){var e;t instanceof n?(e=t,e.collection=s):e=new s.model(t,{collection:s}),s.models.push(e),i&&e.save()})},remove:function(t){var i=t instanceof Array?t:[t];e.utils.arrayForEach(i,function(t){t.destroy()})},find:function(t){return t?e.utils.arrayFirst(this.models(),function(i){if("object"!=typeof t)return i.id()===t?!0:!1;var r=!0;for(var n in t)if(e.utils.unwrapObservable(i.attributes[n])!==t[n]){r=!1;break}return r}):!1},where:function(t){return t?e.utils.arrayFilter(this.models(),function(i){var r=!0;for(var n in t){if(i.idAttribute===n&&i.id()!==t[n]){r=!1;break}if(e.utils.unwrapObservable(i.attributes[n])!==t[n]){r=!1;break}}return r}):[]},toJSON:function(){var t=[];return e.utils.arrayForEach(this.models(),function(e){t.push(e.toJSON())}),t}}),i.Sync=function(i,n,s){if(t.$===void 0)throw"jQuery is necessary to make Ajax calls";var o={},a=s||{};switch(o.dataType="json",o.error=function(){r.wrapError(arguments)},o.url=r.unwrapValue(n,"url"),i){case"fetch":o.type="GET";break;case"create":o.type="POST",n.name?(o.data={},o.data[n.name]=n.toJSON()):o.data=n.toJSON();break;case"update":o.type="PUT",n.name?(o.data={},o.data[n.name]=n.toJSON()):o.data=n.toJSON();break;case"destroy":o.type="DELETE"}return t.$.ajax(e.utils.extend(o,a))},s.extend=n.extend=r.extendClass}).call(this);