/*! Knockout App - v0.2.0 - 2012-12-27
* https://github.com/paglias/KnockoutApp
* Copyright (c) 2012 Matteo Pagliazzi; Licensed MIT */

(function(){var t=this,e=t.ko;if(e===void 0)throw"knockoutJS must be loaded to use KnockoutApp";var r=t.KnockoutApp={};r.VERSION="0.2.0";var i=r.Utils={isObservableArray:function(t){return e.isObservable(t)&&void 0!==t.destroyAll},extendObjKnockout:function(t,r){for(var n in r){var o=r[n];"object"==typeof o&&null!==o&&t[n]&&!e.isWriteableObservable(t[n])?i.extendObjKnockout(t[n],o):i.isObservableArray(t[n])?o instanceof Array?t[n](o):t[n].push(o):e.isWriteableObservable(t[n])?t[n](o):t[n]=o}return t},cloneObjKnockout:function(t){if(e.isWriteableObservable(t))return e.observable(t());if(null===t||"object"!=typeof t)return t;var r=t.constructor();for(var n in t)r[n]=i.cloneObjKnockout(t[n]);return r},extendClass:function(t,r){var i,n=this,o=function(){};return i=t&&t.hasOwnProperty("constructor")?t.constructor:function(){n.apply(this,arguments)},e.utils.extend(i,n),o.prototype=n.prototype,i.prototype=new o,t&&e.utils.extend(i.prototype,t),r&&e.utils.extend(i,r),i.prototype.constructor=i,i.__super__=n.prototype,i.extend=n.extend,i},unwrapValue:function(t,e){if(null===t)return null;var r=t[e];return"function"==typeof r?r.call(t):r},wrapError:function(){var t=Array.prototype.slice.call(arguments);console.log("Error ",t)}},n=r.Model=function(t,r){this.id=e.observable(!1),this.attributes={},t&&(t[this.idAttribute]&&(this.id(t[this.idAttribute]),delete t[this.idAttribute]),this.attributes=i.extendObjKnockout(i.cloneObjKnockout(this.defaultAttributes),t)),r&&r.collection&&(this.collection=r.collection),this.isNew=e.computed(function(){return this.id()===!1?!0:!1},this),this.initialize&&this.initialize.apply(this,arguments)};e.utils.extend(n.prototype,{defaultAttributes:{},idAttribute:"id",sync:function(){return(this.collection&&this.collection.sync||r.Sync).apply(this,arguments)},url:function(){var t=i.unwrapValue(this,"baseUrl")||this.collection&&i.unwrapValue(this.collection,"url");return this.isNew()?t:t+("/"===t[t.length-1]?"":"/")+this.id()},validate:function(){return!0},fetch:function(t){var r=this,n={};return n.success=function(t){delete t[r.idAttribute],r.attributes=i.extendObjKnockout(i.cloneObjKnockout(r.defaultAttributes),t)},n.error=function(){i.wrapError(arguments)},t&&e.utils.extend(n,t),this.sync.call(this,"fetch",this,n)},save:function(t){if(this.validate()!==!0)return!1;var r=this,n={},o=this.isNew()?"create":"update";return n.success=function(t){"create"===o&&r.id(t[r.idAttribute])},n.error=function(){i.wrapError(arguments)},t&&e.utils.extend(n,t),this.sync.call(this,o,this,n)},destroy:function(t){if(this.isNew())return this.collection&&this.collection.models.remove(this),!1;if(!this.isNew()){var r={},n=this;return r.success=function(){n.collection&&n.collection.models.remove(n)},r.error=function(){i.wrapError(arguments)},t&&e.utils.extend(r,t),this.sync.call(this,"destroy",this,r)}},toJSON:function(){var t=e.toJS(this.attributes);return this.id()&&(t[this.idAttribute]=this.id()),t}});var o=r.Collection=function(t){if(!t)throw"A model must be provided for a collection";this.model=t,this.models=e.observableArray(),this.initialize&&this.initialize.apply(this,arguments)};e.utils.extend(o.prototype,{sync:function(){return r.Sync.apply(this,arguments)},fetch:function(t){var r=this,n={};return n.success=function(t){var e=[];for(var i in t)e.push(t[i]);e.length>0&&r.add(e)},n.error=function(){i.wrapError(arguments)},n&&e.utils.extend(n,t),this.sync.call(this,"fetch",this,n)},add:function(t,r){var i=t instanceof Array?t:[t],o=this;e.utils.arrayForEach(i,function(t){var e;t instanceof n?(e=t,e.collection=o):e=new o.model(t,{collection:o}),o.models.push(e),r&&e.save()})},remove:function(t){var r=t instanceof Array?t:[t];e.utils.arrayForEach(r,function(t){t.destroy()})},find:function(t){return t?e.utils.arrayFirst(this.models(),function(e){if("object"!=typeof t)return e.id()===t?!0:!1;var r=!0;for(var i in t)if(e.attributes[i]!==t[i]){r=!1;break}return r}):!1},where:function(t){return t?e.utils.arrayFilter(this.models(),function(e){var r=!0;for(var i in t){if(e.idAttribute===i&&e.id()!==t[i]){r=!1;break}if(e.attributes[i]!==t[i]){r=!1;break}}return r}):[]},toJSON:function(){var t=[];return e.utils.arrayForEach(this.models(),function(e){t.push(e.toJSON())}),t}}),r.Sync=function(r,n,o){if(t.$===void 0)throw"jQuery is necessary to make Ajax calls";var s={},a=o||{};switch(s.dataType="json",s.url=i.unwrapValue(n,"url"),r){case"fetch":s.type="GET";break;case"create":s.type="POST",n.modelName?(s.data={},s.data[n.modelName]=n.toJSON()):s.data=n.toJSON();break;case"update":s.type="PUT",n.modelName?(s.data={},s.data[n.modelName]=n.toJSON()):s.data=n.toJSON();break;case"destroy":s.type="DELETE"}return t.$.ajax(e.utils.extend(s,a))},o.extend=n.extend=i.extendClass}).call(this);